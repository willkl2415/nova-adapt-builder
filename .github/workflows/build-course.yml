name: Build SCORM Package

on:
  push:
    paths:
      - 'courses/**'
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout nova-adapt-builder
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Detect course to build
        id: detect
        run: |
          COURSE_DIR=$(find courses -mindepth 1 -maxdepth 1 -type d | head -1)
          COURSE_ID=$(basename "$COURSE_DIR")
          echo "course_id=$COURSE_ID" >> $GITHUB_OUTPUT
          echo "course_dir=$COURSE_DIR" >> $GITHUB_OUTPUT
          echo "Building course: $COURSE_ID"

      - name: Clone Adapt Framework
        run: |
          git clone https://github.com/adaptlearning/adapt_framework.git build-workspace
          cd build-workspace
          git checkout tags/v5.54.0

      - name: Install framework dependencies
        run: |
          cd build-workspace
          npm install --ignore-scripts

      - name: Install plugins from GitHub
        run: |
          cd build-workspace
          
          # Core
          git clone https://github.com/adaptlearning/adapt-contrib-core.git src/core
          
          # Theme
          rm -rf src/theme/adapt-contrib-vanilla
          git clone https://github.com/adaptlearning/adapt-contrib-vanilla.git src/theme/adapt-contrib-vanilla
          
          # Menu
          git clone https://github.com/adaptlearning/adapt-contrib-boxMenu.git src/menu/adapt-contrib-boxMenu
          
          # Components
          git clone https://github.com/adaptlearning/adapt-contrib-text.git src/components/adapt-contrib-text
          git clone https://github.com/adaptlearning/adapt-contrib-narrative.git src/components/adapt-contrib-narrative
          git clone https://github.com/adaptlearning/adapt-contrib-media.git src/components/adapt-contrib-media
          git clone https://github.com/adaptlearning/adapt-contrib-matching.git src/components/adapt-contrib-matching
          git clone https://github.com/adaptlearning/adapt-contrib-mcq.git src/components/adapt-contrib-mcq
          git clone https://github.com/adaptlearning/adapt-contrib-gmcq.git src/components/adapt-contrib-gmcq
          git clone https://github.com/adaptlearning/adapt-contrib-textInput.git src/components/adapt-contrib-textInput
          git clone https://github.com/adaptlearning/adapt-contrib-slider.git src/components/adapt-contrib-slider
          git clone https://github.com/adaptlearning/adapt-contrib-accordion.git src/components/adapt-contrib-accordion
          git clone https://github.com/adaptlearning/adapt-contrib-hotgraphic.git src/components/adapt-contrib-hotgraphic
          git clone https://github.com/adaptlearning/adapt-contrib-blank.git src/components/adapt-contrib-blank
          
          # Extensions
          git clone https://github.com/adaptlearning/adapt-contrib-assessment.git src/extensions/adapt-contrib-assessment
          git clone https://github.com/adaptlearning/adapt-contrib-assessmentResults.git src/extensions/adapt-contrib-assessmentResults
          git clone https://github.com/adaptlearning/adapt-contrib-bookmarking.git src/extensions/adapt-contrib-bookmarking
          git clone https://github.com/adaptlearning/adapt-contrib-resources.git src/extensions/adapt-contrib-resources
          git clone https://github.com/adaptlearning/adapt-contrib-spoor.git src/extensions/adapt-contrib-spoor
          git clone https://github.com/adaptlearning/adapt-contrib-trickle.git src/extensions/adapt-contrib-trickle
          git clone https://github.com/adaptlearning/adapt-contrib-pageLevelProgress.git src/extensions/adapt-contrib-pageLevelProgress
          git clone https://github.com/adaptlearning/adapt-contrib-tutor.git src/extensions/adapt-contrib-tutor

      - name: Copy NOVA course content
        run: |
          COURSE_ID=${{ steps.detect.outputs.course_id }}
          cp config/config.json build-workspace/src/course/config.json
          cp courses/$COURSE_ID/en/course.json build-workspace/src/course/en/course.json
          cp courses/$COURSE_ID/en/contentObjects.json build-workspace/src/course/en/contentObjects.json
          cp courses/$COURSE_ID/en/articles.json build-workspace/src/course/en/articles.json
          cp courses/$COURSE_ID/en/blocks.json build-workspace/src/course/en/blocks.json
          cp courses/$COURSE_ID/en/components.json build-workspace/src/course/en/components.json

      - name: Build SCORM package
        run: |
          cd build-workspace
          npx grunt build

      - name: Package SCORM zip
        run: |
          COURSE_ID=${{ steps.detect.outputs.course_id }}
          cd build-workspace/build
          zip -r ../../${COURSE_ID}-scorm.zip .

      - name: Upload SCORM package
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.detect.outputs.course_id }}-scorm
          path: ${{ steps.detect.outputs.course_id }}-scorm.zip
          retention-days: 90
